<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.doran.post.dao.PostDAO">

	<!-- 게시물 목록 -->
	<select id="postList" resultType="com.project.doran.post.vo.PostVO">
		SELECT distinct p.*, u.nickname
		FROM postTbl p
			LEFT OUTER JOIN userTbl u ON p.uid = u.uid
			LEFT OUTER JOIN postTagMappingTbl pt ON pt.postId = p.postId
   			LEFT OUTER JOIN tagTbl t ON t.tagId = pt.tagId
		WHERE groupId = #{groupId} 
			AND p.isDeleted = 0
		<if test="keyword != null and keyword != ''">
			AND (content LIKE CONCAT('%',#{keyword},'%') 
			OR u.nickname LIKE CONCAT('%',#{keyword},'%') 
			OR t.tagName LIKE CONCAT('%',#{keyword},'%'))
		</if>
		ORDER BY postedDate DESC;
	</select>

	<!-- 이미지 파일 목록 -->
	<select id="postImageList" resultType="com.project.doran.attch.vo.AttchVO">
		SELECT a.*
		FROM attchTbl a
			LEFT OUTER JOIN postTbl p ON a.postId = p.postId
		    LEFT OUTER JOIN groupTbl g ON p.groupId = g.groupId
		WHERE p.groupId = #{groupId}
			AND p.isDeleted = 0
	</select>

	<!-- 태그 목록 -->
	<select id="tagList" resultType="com.project.doran.tag.vo.TagVO">
		SELECT p.groupId, p.postId, t.tagId, t.tagName
		FROM tagTbl t
			LEFT OUTER JOIN postTagMappingTbl pt ON t.tagId = pt.tagId
		    LEFT OUTER JOIN postTbl p ON pt.postId = p.postId
		WHERE p.groupId = #{groupId}
			AND p.isDeleted = 0;
	</select>

	<!-- 게시물 작성 -->
	<insert id="postWrite" useGeneratedKeys="true" keyProperty="postId">
		INSERT INTO postTbl(groupId, uid, content, openness) 
		VALUES (#{groupId}, #{uid}, #{content}, #{openness})
	</insert>

	<!-- 이미지 파일 등록 -->
	<insert id="postImageUpload">
		INSERT INTO attchTbl(attchId, postId, srvFileName, localFileName, filePath)
		VALUES (#{attchId}, #{postId}, #{srvFileName}, #{localFileName}, #{filePath})
	</insert>

	<!-- 태그 등록 -->
	<insert id="tagUpload" useGeneratedKeys="true" keyProperty="tagId">
		INSERT INTO tagTbl(tagName) '
		VALUES (#{tagName})
	</insert>

	<!-- 태그 중복 체크 -->
	<select id="tagCheck" resultType="Integer">
		SELECT tagId 
		FROM tagTbl
		WHERE tagName = #{tagName}
	</select>
	
	<!-- 게시물-태그 매핑 -->
	<insert id="postTagMapping">
		INSERT INTO postTagMappingTbl(postId, tagId) 
		VALUES (#{postId}, #{tagId})
	</insert>

	<!-- 게시물 수정 -->
	<update id="postUpdate">
		UPDATE postTbl 
		SET content = #{content}, openness = #{openness}, isRevised = 1, revisedDate = now()
		WHERE postId = #{postId}
	</update>
	
	<!-- 이미지 파일 수정 : 기존 이미지 파일 삭제 후 이미지 파일 등록 -->
	<delete id="postImageDelete">
		DELETE attchTbl 
		WHERE postId = #{postId}
	</delete>
	
	<!-- 게시물 삭제 -->
	<update id="postDelete">
		UPDATE postTbl 
		SET isDeleted = 1, deletedDate = now()
		WHERE postId = #{postId}
	</update>

	<!-- 인기 게시물 목록 -->
	<select id="hotPostList" resultType="com.project.doran.post.vo.PostVO">
		<![CDATA[
		SELECT * 
		FROM postTbl
		WHERE groupId = #{groupId} 
			AND openness != 3 
			AND isDeleted = 0 
			AND postedDate 
			BETWEEN DATE_ADD(NOW(),INTERVAL -1 WEEK ) AND NOW()
		ORDER BY likeCount DESC, postedDate DESC
		LIMIT 5
		]]>
	</select>

</mapper>